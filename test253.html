<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–¼í‰ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f5; margin: 0; padding: 0; }
        .container { margin-top: 50px; padding: 20px; }
        .hidden { display: none; }
        h1, h2 { color: #333; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; font-size: 16px; cursor: pointer; margin-top: 20px; border-radius: 8px; }
        button:hover { background-color: #0056b3; }
        .upload-box { border: 2px dashed #007bff; padding: 20px; width: 300px; margin: auto; cursor: pointer; background-color: white; }
        .upload-box img { width: 100%; display: none; margin-top: 10px; border-radius: 8px; }
        .loading { font-size: 22px; color: #555; margin-top: 20px; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        #resultContainer { text-align: center; margin-top: 20px; }
        #resultCanvas { border-radius: 10px; max-width: 80%; display: block; margin: auto; }
        .result-box { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); text-align: left; display: inline-block; width: 80%; max-width: 600px; }
    </style>
</head>
<body>

    <div id="mainPage" class="container">
        <h1>ì–¼í‰ í…ŒìŠ¤íŠ¸</h1>
        <button onclick="showPage('uploadPage')">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="uploadPage" class="container hidden">
        <h2>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”!</h2>
        <div class="upload-box" onclick="document.getElementById('imageUpload').click();">
            <p>ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</p>
            <img id="previewImage">
        </div>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        <button onclick="startLoading()">ê²°ê³¼ ë³´ê¸°</button>
    </div>

    <div id="loadingPage" class="container hidden">
        <h2>ì–¼êµ´ ë¶„ì„ ì¤‘...</h2>
        <p class="loading">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!</p>
    </div>

    <div id="resultPage" class="container hidden">
        <h2>ì–¼í‰ ê²°ê³¼</h2>
        <div id="resultContainer">
            <canvas id="resultCanvas"></canvas>
            <div class="result-box" id="faceAnalysis">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <button onclick="showPage('mainPage')">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    
    <!-- âœ… showPage() í•¨ìˆ˜ë¥¼ ê°€ì¥ ë¨¼ì € ì„ ì–¸ -->
    <script>
    function showPage(pageId) {
        document.querySelectorAll('.container').forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
    }

    async function loadModels() {
    console.log("ğŸ“¥ ëª¨ë¸ ë¡œë“œ ì¤‘...");
    
    const modelUrl = "/models";  // models í´ë”ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°

    try {
        await faceapi.nets.ssdMobilenetv1.loadFromUri(modelUrl);
        await faceapi.nets.faceLandmark68TinyNet.loadFromUri(modelUrl);
        console.log("âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!");
    } catch (error) {
        console.error("âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", error);
    }
}

async function startApp() {
    console.log("ğŸ“¥ startApp() ì‹¤í–‰ë¨! face-api.js ë¡œë”© í™•ì¸ ì¤‘...");

    if (typeof faceapi === "undefined") {
        console.error("âŒ face-api.jsê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
        return;
    }

    console.log("âœ… face-api.js ë¡œë“œ ì™„ë£Œ!");
    await loadModels();
}

// âœ… face-api.jsê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
async function waitForFaceAPI() {
    console.log("â³ face-api.js ë¡œë”© ì¤‘...");

    const checkInterval = setInterval(() => {
        if (typeof faceapi !== "undefined") {
            console.log("âœ… face-api.js ì™„ì „íˆ ë¡œë“œë¨!");
            clearInterval(checkInterval);
            startApp();
        }
    }, 500);
}

    document.getElementById("imageUpload").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById("previewImage").src = e.target.result;
                document.getElementById("previewImage").style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    async function startLoading() {
        if (!document.getElementById("imageUpload").files.length) {
            alert("ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
            return;
        }

        showPage("loadingPage");

        const reader = new FileReader();
        reader.onload = function(event) {
            localStorage.setItem('uploadedImage', event.target.result);
            setTimeout(async () => {
                await analyzeImage();
            }, 3000);
        };
        reader.readAsDataURL(document.getElementById("imageUpload").files[0]);
    }

    async function analyzeImage() {
        console.log("ğŸ“¸ ì´ë¯¸ì§€ ë¶„ì„ ì‹œì‘!");

        // âœ… faceapi ë¡œë“œ í™•ì¸ (ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰ ì¤‘ì§€)
        if (typeof faceapi === "undefined") {
            console.error("âŒ face-api.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
            document.getElementById("faceAnalysis").innerHTML = "âŒ ì–¼êµ´ ê°ì§€ ì˜¤ë¥˜: face-api.jsê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ!";
            return;
        }

        showPage("resultPage");
        document.getElementById("faceAnalysis").innerHTML = "ì–¼êµ´ ë¶„ì„ ì¤‘...";

        const canvas = document.getElementById("resultCanvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.src = localStorage.getItem('uploadedImage'); 

        img.onload = async function() {
            canvas.width = img.width / 2;
            canvas.height = img.height / 2;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            try {
                const detections = await faceapi.detectSingleFace(canvas, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks();

                if (detections) {
                    document.getElementById("faceAnalysis").innerHTML = "âœ… ì–¼êµ´ ë¶„ì„ ì™„ë£Œ!<br>ì„¸ë ¨ëœ ì¸ìƒì„ ì£¼ëŠ” ì–¼êµ´ì…ë‹ˆë‹¤!";
                } else {
                    document.getElementById("faceAnalysis").innerHTML = "âŒ ì–¼êµ´ì„ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”!";
                }
            } catch (error) {
                document.getElementById("faceAnalysis").innerHTML = "âš ï¸ ì–¼êµ´ ê°ì§€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!";
                console.error("âŒ ì–¼êµ´ ê°ì§€ ì˜¤ë¥˜:", error);
            }
        };
    }
    </script>
</body>
</html>
